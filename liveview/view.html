<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Live View</title>
        <style>
        img, #bg { position: absolute; left:0; top:0; z-index: -1; border: 1px solid grey; }
        img { visibility: hidden; }
        img.main { visibility: visible; }
        img#bgim { visibility: visible; }
        div#bg { width: 1404px; height: 1872px; }
        </style>
    </head>
    <body>

        <div id="bg"><img id="bgim"></img></div>
        <img id="i" src="out.svg"></img>
        <img id="j" src="out.svg"></img>
        <input id="c1" type="checkbox" title="rotate"  onchange="applyRotate()"></input>
        <input id="c2" type="checkbox" title="refresh" onchange="toggleInterval()"></input>

        <script>
            bg = document.querySelector('#bg');
            bgim = document.querySelector('#bgim');
            i = document.querySelector('#i');
            j = document.querySelector('#j');
            c1 = document.querySelector('#c1');
            c2 = document.querySelector('#c2');
            inter = -1;
            a = [i, j];

            refresh = () => {
              let a0 = a[0];
              let a1 = a[1];
              a0.onload = null;
              a1.onload = () => {
                a1.className = 'main';
                a0.className = '';
              };

              a1.src = window.location.hash.substr(1)+'?'+Date.now();
              a = [a1, a0];
            }
            refreshBackground = (clr) => {
              if (clr) bgim.src = ""
              else bgim.src = window.location.hash.substr(1)+'.png?'+Date.now();
            }

            function toggleInterval() {
              if (inter == -1) {
                inter = setInterval(refresh, 1000);
                c2.checked = true;
              } else {
                clearInterval(inter);
                inter = -1;
                c2.checked = false;
              }
            }

            function applyRotate() {
              if (c1.checked) {
                 bg.style = 'transform: rotate(90deg) translateY(-100%); transform-origin: top left;';
                 i.style = 'transform: rotate(90deg) translateY(-100%); transform-origin: top left;';
                 j.style = 'transform: rotate(90deg) translateY(-100%); transform-origin: top left;';
              } else {
                 bg.style = '';
                 j.style = '';
                 i.style = '';
              }
            }

            toggleInterval();
            toggleInterval();
            c1.checked = true ; applyRotate();

            var ws = new WebSocket("ws://localhost:4257");
            ws.addEventListener('message', function({data, ...o}) {
              console.log("DATA", data)
              if (data == 'svg') refresh()
              else if (data == 'background') refreshBackground()
              else if (data == 'rmbackground') refreshBackground(true)
              else console.log(data)
            });
            refresh();
        </script>
    </body>
</html>
