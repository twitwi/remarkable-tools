<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Live View</title>
        <style>
        img, #bg { position: absolute; left:0; top:0; z-index: -1; border: 1px solid grey; }
        img { visibility: hidden; }
        img.main { visibility: visible; }
        img#bgim { visibility: visible; }
        div#bg { width: 1404px; height: 1872px; }
        #advanced { display: inline-block; background: yellow; box-sizing: border-box; border: 1px solid black; border-radius: 5px; }
        #advanced * { margin: 10px; }
        #advanced:not(:hover) { width: 1em; height: 1em; overflow: hidden; }
        </style>
    </head>
    <body>

        <div id="bg"><img id="bgim"></img></div>
        <img id="i" src="out.svg"></img>
        <img id="j" src="out.svg"></img>
        <div id="advanced">
          <label><input id="c1" type="checkbox" title="rotate"  onchange="applyRotate()"></input> rotate</label>
          <br/>
          <button onclick="ws.send('preload-bg')">preload background</button>
        </div>
        <div id="info"></div>

        <script>

            bg = document.querySelector('#bg')
            bgim = document.querySelector('#bgim')
            i = document.querySelector('#i')
            j = document.querySelector('#j')
            c1 = document.querySelector('#c1')
            c2 = document.querySelector('#c2')
            info = document.querySelector('#info')

            addInfo = (inf) => {
              let e = document.createElement('div')
              e.textContent = inf
              info.append(e)
            }
            removeInfo = (inf) => {
              document.querySelectorAll('#info>div').forEach( (e) => {
                if (e.textContent == inf) info.removeChild(e)
              });
            }

            a = [i, j];
            refresh = () => {
              let a0 = a[0];
              let a1 = a[1];
              a0.onload = null;
              a1.onload = () => {
                a1.className = 'main';
                a0.className = '';
              };

              a1.src = window.location.hash.substr(1)+'.svg?'+Date.now();
              a = [a1, a0];
            }

            refreshBackground = (p) => {
              if (p === "CLEAR") bgim.src = ""
              else bgim.src = window.location.hash.substr(1)+'.pdf-'+p+'.jpg?'+Date.now();
            }

            applyRotate = () => {
              localStorage.setItem('rotate', c1.checked)
              if (c1.checked) {
                 bg.style = 'transform: rotate(90deg) translateY(-100%); transform-origin: top left;';
                 i.style = 'transform: rotate(90deg) translateY(-100%); transform-origin: top left;';
                 j.style = 'transform: rotate(90deg) translateY(-100%); transform-origin: top left;';
              } else {
                 bg.style = '';
                 j.style = '';
                 i.style = '';
              }
            }

            REST = ""
            startsWith = (all, beg) => {
              REST = ""
              if (all.startsWith(beg)) {
                REST = all.substr(beg.length)
                return true
              }
              return false
            }

            // default rotated?
            c1.checked = localStorage.getItem('rotate') == 'true'
            applyRotate();

            var ws = new WebSocket("ws://localhost:4257");
            ws.addEventListener('message', function({data, ...o}) {
              console.log("DATA", data)
              if (data == 'svg') refresh()
              else if (startsWith(data, 'background:')) refreshBackground(REST)
              else if (startsWith(data, 'info:')) addInfo(REST)
              else if (startsWith(data, 'info-done:')) removeInfo(REST)
              else if (data == 'rmbackground') refreshBackground("CLEAR")
              else console.log(data)
            });
            refresh();
        </script>
    </body>
</html>
